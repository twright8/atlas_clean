{"id":"modules/map.js","dependencies":[{"name":"C:\\Users\\Tom\\PycharmProjects\\health_atlas\\atlas_clean\\package.json","includedInParent":true,"mtime":1741868822789},{"name":"./constants","loc":{"line":1,"column":43,"index":43},"parent":"C:\\Users\\Tom\\PycharmProjects\\health_atlas\\atlas_clean\\src\\modules\\map.js","resolved":"C:\\Users\\Tom\\PycharmProjects\\health_atlas\\atlas_clean\\src\\modules\\constants.js"}],"generated":{"js":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.addMarkers = addMarkers;\nexports.clearMarkers = clearMarkers;\nexports.createMarker = createMarker;\nexports.default = void 0;\nexports.fitMapToBounds = fitMapToBounds;\nexports.getMapBounds = getMapBounds;\nexports.getMarkerIcon = getMarkerIcon;\nexports.initializeMap = initializeMap;\nexports.isMapMoving = isMapMoving;\nexports.onMoveEnd = void 0;\nexports.toggleLegend = toggleLegend;\nvar _constants = require(\"./constants\");\n// Map state\nvar map;\nvar currentLayer;\nvar markers;\nvar legend;\nvar legendAdded = false;\nvar consecutiveErrors = 0;\nvar maxConsecutiveErrors = 5;\n\n/**\r\n * Initialize the map with the base layer and configuration\r\n * @returns {Object} The map instance and related objects\r\n */\nfunction initializeMap() {\n  console.time('Map Initialization');\n\n  // Initialize map centered at [0, 0] with zoom level 2\n  map = L.map('map', {\n    maxZoom: 18,\n    minZoom: 2\n  }).setView([0, 0], 2);\n\n  // Create marker cluster group for better performance with many markers\n  markers = L.markerClusterGroup({\n    chunkedLoading: true,\n    chunkInterval: 200,\n    chunkDelay: 50,\n    maxClusterRadius: 80,\n    disableClusteringAtZoom: 16,\n    spiderfyOnMaxZoom: true\n  });\n  map.addLayer(markers);\n\n  // Initialize with OpenStreetMap base layer\n  var openStreetMapLayer = L.tileLayer(_constants.tileLayers.openStreetMap.url, _constants.tileLayers.openStreetMap.options);\n  currentLayer = openStreetMapLayer.addTo(map);\n\n  // Setup legend control\n  setupLegend();\n\n  // Setup tile error handling\n  setupTileErrorHandling();\n\n  // Setup map event listeners\n  setupMapEvents();\n  console.timeEnd('Map Initialization');\n  return {\n    map: map,\n    markers: markers,\n    legend: legend\n  };\n}\n\n/**\r\n * Set up the legend for the map\r\n */\nfunction setupLegend() {\n  legend = L.control({\n    position: _constants.markerSettings.legendPosition\n  });\n  legend.onAdd = function (map) {\n    var div = L.DomUtil.create('div', 'info legend');\n    div.innerHTML = \"\\n            <div class=\\\"legend-content\\\">\\n                <h4>Location Precision</h4>\\n                <i style=\\\"color: #3694d1;\\\" class=\\\"fa fa-map-marker\\\"></i> Specific Location in Country (e.g., city, facility)<br>\\n                <i style=\\\"color: #e5007d;\\\" class=\\\"fa fa-map-marker\\\"></i> Country Only (no specific location)\\n            </div>\\n        \";\n    return div;\n  };\n}\n\n/**\r\n * Set up tile error handling to switch between providers if one fails\r\n */\nfunction setupTileErrorHandling() {\n  currentLayer.on('tileerror', function (error) {\n    console.log('Tile loading error:', error);\n    consecutiveErrors++;\n    if (consecutiveErrors >= maxConsecutiveErrors) {\n      console.log(\"\".concat(maxConsecutiveErrors, \" consecutive errors. Switching tile layer.\"));\n      switchTileLayer();\n      consecutiveErrors = 0;\n    }\n  });\n  currentLayer.on('tileload', function () {\n    consecutiveErrors = 0;\n  });\n}\n\n/**\r\n * Switch between tile layers when the current one has issues\r\n */\nfunction switchTileLayer() {\n  map.removeLayer(currentLayer);\n  var openStreetMapLayer = L.tileLayer(_constants.tileLayers.openStreetMap.url, _constants.tileLayers.openStreetMap.options);\n  var stamenTerrainLayer = L.tileLayer(_constants.tileLayers.stamenTerrain.url, _constants.tileLayers.stamenTerrain.options);\n  if (currentLayer._url === _constants.tileLayers.openStreetMap.url) {\n    currentLayer = stamenTerrainLayer.addTo(map);\n    console.log('Switched to Stamen Terrain tiles');\n  } else {\n    currentLayer = openStreetMapLayer.addTo(map);\n    console.log('Switched to OpenStreetMap tiles');\n  }\n}\n\n// Callback for when map move ends\nvar onMoveEnd = exports.onMoveEnd = null;\n\n/**\r\n * Setup map event listeners\r\n */\nfunction setupMapEvents() {\n  map.on('movestart', function () {\n    map.isMoving = function () {\n      return true;\n    };\n  });\n  map.on('moveend', function () {\n    map.isMoving = function () {\n      return false;\n    };\n    if (typeof onMoveEnd === 'function') {\n      onMoveEnd();\n    }\n  });\n}\n\n/**\r\n * Get marker icon based on location type\r\n * @param {Boolean} isCountryLevel Whether the location is country-level only\r\n * @returns {Object} Leaflet divIcon for the marker\r\n */\nfunction getMarkerIcon(isCountryLevel) {\n  if (isCountryLevel) {\n    return L.divIcon(_constants.markerSettings.countryIcon);\n  }\n  return L.divIcon(_constants.markerSettings.specificIcon);\n}\n\n/**\r\n * Create a marker with popup for a location\r\n * @param {Object} location Location data object\r\n * @returns {Object} Leaflet marker\r\n */\nfunction createMarker(location) {\n  var icon = getMarkerIcon(location.country_level);\n\n  // Handle potential missing values safely\n  var title = location.Title || 'No Title';\n  var country = location.country || 'Unknown';\n  var url = location.url || '#';\n  var date = location['Date'] || 'Unknown Date';\n  var corruptionCategories = Array.isArray(location['Corruption Categories']) ? String(location['Corruption Categories']).replace(/,(?=[^\\s])/g, ', ') : '';\n  var sectorCategories = Array.isArray(location['Sector Categories']) ? String(location['Sector Categories']).replace(/,(?=[^\\s])/g, ', ') : '';\n  return L.marker([location.lat, location.long], {\n    icon: icon\n  }).bindPopup(\"\\n            <div class=\\\"popup-content\\\">\\n                <h3 class=\\\"popup-title\\\">\\\"\".concat(title, \"\\\"</h3>\\n                <div class=\\\"popup-details\\\">\\n                    <p><strong>Country:</strong> \").concat(country, \"</p>\\n                    <p><strong>URL:</strong> \").concat(url !== '#' ? \"<a href=\\\"\".concat(url, \"\\\" target=\\\"_blank\\\">Link</a>\") : 'No URL', \"</p>\\n                    <p><strong>Date:</strong> \").concat(date, \"</p>\\n                    <p><strong>Integrity Area:</strong> \").concat(corruptionCategories, \"</p>\\n                    <p><strong>Sector Area:</strong> \").concat(sectorCategories, \"</p>\\n                </div>\\n            </div>\\n        \"));\n}\n\n/**\r\n * Show or hide the legend based on the country level filter\r\n * @param {Boolean} showLegend Whether to show the legend\r\n */\nfunction toggleLegend(showLegend) {\n  if (showLegend && !legendAdded) {\n    legend.addTo(map);\n    legendAdded = true;\n  } else if (!showLegend && legendAdded) {\n    legend.remove();\n    legendAdded = false;\n  }\n}\n\n/**\r\n * Fit the map view to the marker bounds\r\n */\nfunction fitMapToBounds() {\n  if (markers.getBounds().isValid()) {\n    map.fitBounds(markers.getBounds());\n  }\n}\n\n/**\r\n * Get the current map bounds\r\n * @returns {Object} Map bounds\r\n */\nfunction getMapBounds() {\n  return map.getBounds();\n}\n\n/**\r\n * Check if map is currently moving\r\n * @returns {Boolean} Whether map is moving\r\n */\nfunction isMapMoving() {\n  return map.isMoving ? map.isMoving() : false;\n}\n\n/**\r\n * Clear all markers from the map\r\n */\nfunction clearMarkers() {\n  markers.clearLayers();\n}\n\n/**\r\n * Add markers to the map in chunks to maintain performance\r\n * @param {Array} markerArray Array of Leaflet markers\r\n */\nfunction addMarkers(markerArray) {\n  markers.addLayers(markerArray);\n}\n\n/**\r\n * Export map module state for external use\r\n */\nvar _default = exports.default = {\n  initializeMap: initializeMap,\n  getMarkerIcon: getMarkerIcon,\n  createMarker: createMarker,\n  toggleLegend: toggleLegend,\n  fitMapToBounds: fitMapToBounds,\n  getMapBounds: getMapBounds,\n  isMapMoving: isMapMoving,\n  clearMarkers: clearMarkers,\n  addMarkers: addMarkers\n};"},"sourceMaps":null,"error":null,"hash":"53dc2124405e38f2fd7a8c220ae99c0d","cacheData":{"env":{}}}